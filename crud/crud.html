<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple CRUD Table</title>
    <link rel="stylesheet" href="crud.css">
</head>
<body>

<div class="main">
    <h1>SSS Online Form</h1>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>First</th>
                <th>Last</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Location</th>
                <th>Hobby</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>

    <div class="footer-actions">
        <button class="btn btn-add" onclick="window.location.href='../page1/page1.html'">Add New Record</button>
        <a href="../age-cal/age-calculator.html" class="btn btn-view">View Ages</a>
    </div>
</div>

<!-- Modal for Add/Edit -->
<div id="modal" class="modal" style="display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 40%;">
        <h3 id="modal-title">Add New Item</h3>
        <form id="item-form">
            <input type="hidden" id="item-id">
            <p><label>First Name: <input type="text" id="first" required></label></p>
            <p><label>Last Name: <input type="text" id="last" required></label></p>
            <p><label>Email: <input type="email" id="email" required></label></p>
            <p><label>Phone: <input type="text" id="phone"></label></p>
            <p><label>Location: <input type="text" id="location"></label></p>
            <p><label>Hobby: <input type="text" id="hobby"></label></p>
            <p>
                <button type="submit" class="btn btn-add">Save</button>
                <button type="button" class="btn btn-del" onclick="closeModal()">Cancel</button>
            </p>
        </form>
    </div>
</div>

<script>
    let userData = [];

    // Load data from server
    async function loadData() {
        try {
            const response = await fetch('crud.php?action=read');
            userData = await response.json();
            renderTable();
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    const tableBody = document.getElementById('table-body');

    // Render function using forEach
    function renderTable() {
        // Clear existing content
        tableBody.innerHTML = "";

        // Loop through each item in the array
        userData.forEach((user) => {
            const row = `
                <tr>
                    <td class="id-col">${user.id}</td>
                    <td>${user.first}</td>
                    <td>${user.last}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>${user.location}</td>
                    <td>${user.hobby}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editItem(${user.id})">Edit</button>
                        <button class="btn btn-del" onclick="deleteItem(${user.id})">Del</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // Show modal for adding new item
    function addItem() {
        document.getElementById('modal-title').textContent = 'Add New Item';
        document.getElementById('item-form').reset();
        document.getElementById('item-id').value = '';
        document.getElementById('modal').style.display = 'block';
    }

    // Populate form and show modal for editing
    function editItem(id) {
        const user = userData.find(u => u.id == id);
        if (user) {
            document.getElementById('modal-title').textContent = 'Edit Item';
            document.getElementById('item-id').value = user.id;
            document.getElementById('first').value = user.first;
            document.getElementById('last').value = user.last;
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('location').value = user.location || '';
            document.getElementById('hobby').value = user.hobby || '';
            document.getElementById('modal').style.display = 'block';
        }
    }

    // Delete item
    async function deleteItem(id) {
        if (confirm("Are you sure you want to delete ID: " + id + "?")) {
            try {
                const formData = new FormData();
                formData.append('id', id);

                const response = await fetch('crud.php?action=delete', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert("Record deleted successfully");
                    loadData(); // Reload data
                } else {
                    alert("Error: " + result.message);
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert("Error deleting record");
            }
        }
    }


    // Close modal
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    // Handle form submission
    document.getElementById('item-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const id = document.getElementById('item-id').value;
        const first = document.getElementById('first').value;
        const last = document.getElementById('last').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const location = document.getElementById('location').value;
        const hobby = document.getElementById('hobby').value;

        const formData = new FormData();
        formData.append('id', id);
        formData.append('first', first);
        formData.append('last', last);
        formData.append('email', email);
        formData.append('phone', phone);
        formData.append('location', location);
        formData.append('hobby', hobby);

        try {
            const action = id ? 'update' : 'create';
            const response = await fetch('crud.php?action=' + action, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert(id ? "Record updated successfully" : "Record created successfully");
                closeModal();
                loadData(); // Reload data
            } else {
                alert("Error: " + result.message);
            }
        } catch (error) {
            console.error('Error saving item:', error);
            alert("Error saving record");
        }
    });

    // Initial call to display the data
    loadData();
</script>

</body>
</html>